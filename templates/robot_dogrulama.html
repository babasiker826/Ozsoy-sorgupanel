<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>2025 — SORGU PANELI</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b001f; --card:#0f0925; --accent1:#00f6ff; --accent2:#ff00d6;
      --ok:#66ff99; --glow:#00ffea; --glitch1:#ff0055; --glitch2:#00ffea;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    html,body{height:100%;font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Arial;color:#e6f7ff;background:#0b001f;overflow:hidden;}

    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;position:relative;z-index:1;}

    .card{
      width:520px; max-width:94vw; border-radius:16px; padding:30px 25px;
      background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
      border:1px solid rgba(0,255,255,0.3); box-shadow:0 0 30px rgba(0,255,255,0.3),0 0 60px rgba(255,0,214,0.2);
      display:flex; flex-direction:column; gap:18px; align-items:center; position:relative; overflow:hidden;
    }

    .brand{display:flex;align-items:center;gap:14px;position:relative; z-index:2;}
    .logo{
      width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--accent1),var(--accent2));
      display:flex;align-items:center;justify-content:center;font-weight:900;color:#001;font-family:'Orbitron',monospace;
      box-shadow:0 0 20px var(--accent1),0 0 40px var(--accent2);
      animation: glow 2s ease-in-out infinite alternate;
    }
    @keyframes glow{
      0%{box-shadow:0 0 20px var(--accent1),0 0 40px var(--accent2);}
      100%{box-shadow:0 0 40px var(--accent1),0 0 80px var(--accent2);}
    }

    h1{font-size:22px;color:var(--accent1);margin:0;font-family:'Orbitron',monospace;}
    .hint{font-size:14px;color:#cfeffd;opacity:0.85;}

    .circle-wrap{display:flex;align-items:center;justify-content:center;position:relative;margin:16px 0;}
    .circle{
      width:160px;height:160px;border-radius:50%;display:flex;align-items:center;justify-content:center;
      background:radial-gradient(circle at 30% 30%, rgba(0,255,234,0.05), rgba(255,0,214,0.02));
      border:4px solid rgba(0,255,234,0.3); cursor:pointer; position:relative;
      box-shadow:0 0 25px var(--accent1),0 0 50px var(--accent2),0 0 100px rgba(255,0,214,0.3);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .circle:active{transform:scale(.95);}
    .circle-inner{
      width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg,var(--accent1),var(--accent2));
      display:flex;align-items:center;justify-content:center;font-weight:900;color:#001;font-size:18px;font-family:'Orbitron',monospace;
      text-shadow:0 0 5px var(--accent1),0 0 15px var(--accent2);
      transition: transform .2s ease;
    }
    .circle:hover{box-shadow:0 0 50px var(--accent1),0 0 100px var(--accent2),0 0 150px rgba(255,0,214,0.5);}
    .circle:hover .circle-inner{transform: scale(1.1);}

    .spinner{width:90px;height:90px;border-radius:50%;border:6px solid rgba(255,255,255,0.08);border-top-color:var(--ok);animation:spin 1s linear infinite;display:none;}
    .circle.busy .circle-inner{display:none;}
    .circle.busy .spinner{display:block;}

    @keyframes spin{to{transform:rotate(360deg);}}

    .subtext{font-size:14px;color:#bfeeff;opacity:0.95;text-align:center;position:relative; z-index:2;}
    .small{font-size:12px;color:#9fdfff;opacity:0.85;position:relative; z-index:2;}

    @media(max-width:420px){
      .circle{width:130px;height:130px}
      .circle-inner{width:80px;height:80px;font-size:16px}
      h1{font-size:18px}
      .card{padding:20px 15px;}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card" role="main" aria-labelledby="title">
    <div class="brand">
      <div class="logo">ÖZSOY</div>
      <div>
        <h1 id="title">ÖZSOY SORGU PANELI DOGRULAMA</h1>
        <p class="hint">Tek tıkla başlar — arka planda sağlam kontroller.</p>
      </div>
    </div>

    <div class="circle-wrap">
      <div id="keneviz-circle" class="circle" role="button" aria-pressed="false" tabindex="0" title="Doğrulamak için tıkla">
        <div class="circle-inner" id="circle-label">Doğrula</div>
        <div class="spinner" id="circle-spinner" aria-hidden="true"></div>
      </div>
    </div>

    <div class="subtext" id="kv-status">Lütfen butona tıklayın. Doğrulama birkaç saniye sürebilir.</div>
    <div class="small" id="next-info"></div>
  </div>
</div>

<script>
(function(){
  const circle = document.getElementById('keneviz-circle');
  const label = document.getElementById('circle-label');
  const spinner = document.getElementById('circle-spinner');
  const status = document.getElementById('kv-status');
  const nextInfo = document.getElementById('next-info');

  // URL'den next parametresini al
  const urlParams = new URLSearchParams(window.location.search);
  const nextPage = urlParams.get('next') || '/login';

  if (nextPage) {
    nextInfo.textContent = `Doğrulama sonrası yönlendirileceksiniz: ${nextPage}`;
  }

  function setBusy(b){
    if(b){
      circle.classList.add('busy');
      circle.setAttribute('aria-pressed','true');
      label.style.display='none';
      spinner.style.display='block';
      status.textContent='Doğrulama başlıyor...';
    }
    else{
      circle.classList.remove('busy');
      circle.setAttribute('aria-pressed','false');
      label.style.display='flex';
      spinner.style.display='none';
    }
  }

  async function getChallenge(){
    try {
      const res = await fetch('/keneviz_challenge', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {'Content-Type': 'application/json'}
      });
      if(!res.ok) throw new Error('Challenge alınamadı');
      return await res.json();
    } catch (error) {
      throw new Error('Sunucuya bağlanılamadı');
    }
  }

  async function verify(challengeData){
    try {
      const res = await fetch('/keneviz_verify', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          challenge_id: challengeData.challenge_id,
          next: nextPage
        })
      });
      if(!res.ok) throw new Error('Doğrulama başarısız');
      return await res.json();
    } catch (error) {
      throw new Error('Doğrulama hatası');
    }
  }

  async function runVerification(){
    try {
      setBusy(true);

      // 1. Challenge al
      status.textContent = 'Güvenlik kontrolü yapılıyor...';
      await new Promise(resolve => setTimeout(resolve, 500));

      const challenge = await getChallenge();
      status.textContent = 'Doğrulama yapılıyor...';

      // 2. Kullanıcı etkileşimi simülasyonu
      await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 400));

      // 3. Doğrulama gönder
      const result = await verify(challenge);

      if (result && result.success) {
        status.textContent = '✅ Doğrulama başarılı! Yönlendiriliyorsunuz...';

        // 2 saniye bekle ve yönlendir
        setTimeout(() => {
          window.location.href = result.redirect || nextPage;
        }, 2000);
      } else {
        status.textContent = '❌ Doğrulama başarısız. Lütfen tekrar deneyin.';
        setBusy(false);
      }

    } catch (error) {
      console.error('Doğrulama hatası:', error);
      status.textContent = '⚠️ Doğrulama hatası. Sayfayı yenileyip tekrar deneyin.';
      setBusy(false);
    }
  }

  // Event listeners
  circle.addEventListener('click', runVerification);
  circle.addEventListener('keydown', function(e){
    if(e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      runVerification();
    }
  });

  // Sayfa yüklendiğinde focus ver
  window.addEventListener('load', function() {
    circle.focus();
  });

})();
</script>
</body>
</html>
